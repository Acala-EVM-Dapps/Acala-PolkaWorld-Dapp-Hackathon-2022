<!DOCTYPE html>

<head>
    <!-- Meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="Cryptohub - Cryptocurrency HTML Template">
    <meta name="keywords"
        content="bitcoin, bitcoin landing, blockchain, cryptocurrency, Cryptocurrency advisor, ICO Agency, ICO Consulting, ico landing, ico template, ico token, ico website">
    <!-- SITE TITLE -->
    <title>MetaDefender HTML Template</title>
    <!-- Latest Bootstrap min CSS -->
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <!-- Google Font -->
    <!-- <link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet"> 
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">  -->
    <!-- Font Awesome CSS -->
    <link rel="stylesheet" href="assets/fonts/font-awesome.min.css">
    <link rel="stylesheet" href="assets/fonts/themify-icons.css">
    <!--- owl carousel Css-->
    <link rel="stylesheet" href="assets/owlcarousel/css/owl.carousel.css">
    <link rel="stylesheet" href="assets/owlcarousel/css/owl.theme.css">
    <!--slicknav Css-->
    <link rel="stylesheet" href="assets/css/slicknav.css">
    <!-- MAGNIFIC CSS -->
    <link rel="stylesheet" href="assets/css/magnific-popup.css">
    <!-- animate CSS -->
    <link rel="stylesheet" href="assets/css/animate.css">
    <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.css">
    <!-- Popup CSS -->
    <!-- <link rel="stylesheet" href="assets/css/popup.css">			 -->
    <!-- Style CSS -->
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/responsive.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
    <!-- css file for this page -->
    <link rel="stylesheet" href="assets/css/buyCover.css">
    <script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script language="javascript" type="text/javascript" src="CPTABI.js"></script>
    <script language="javascript" type="text/javascript" src="coverABI.js"></script>
    <script language="javascript" type="text/javascript" src="publicPoolABI.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/axios/0.26.1/axios.min.js"></script>
</head>

<body data-spy="scroll" data-offset="80">

    <!-- START PRELOADER -->
    <div class="preloader">
        <div class="spinner">
            <div class="double-bounce1"></div>
            <div class="double-bounce2"></div>
        </div>
    </div>
    <!-- END PRELOADER -->

    <!-- START NAVBAR -->
    <div id="navigation" class="fixed-top navbar-light bg-faded site-navigation">
        <div class="container">
            <div class="row">
                <div class="col-lg-3 col-md-3 col-sm-4">
                    <div class="site-logo">
                        <a class="navbar-logo" href="index.html"><img src="assets/img/logo.png" alt=""></a>
                    </div>
                </div>
                <div class="col-lg-9 col-md-9 col-sm-8">
                    <div class="header_right">
                        <nav id="main-menu" class="ml-auto">
                            <ul>
                                <li><a href="./index.html">Home</a></li>
                                <li><a href="./launch.html">Insurance</a></li>
                                <li><a href="./mining.html">Mining</a></li>
                                <li><a href="#" data-toggle="modal" data-target="#myModal">NoahArk</a></li>
                                <li><a class="btn_one linkWallet" id="btn-wallet" onclick="linkWallet()">Wallet</a></li>
                            </ul>
                        </nav>
                        <div id="mobile_menu"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- END NAVBAR -->

    <div class="launch-buy-vover">
        <div class="container">
            <h2>Provide Capital</h2>
            <div class="tip">Enter the amount you want to cover and for how long.</div>
        </div>
    </div>

    <div class="buy-vover-main-wrap">
        <div class="container">
            <div class="buy-vover-main">
                <div class="row">
                    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-8">
                        <div class="part-wrap">
                            <div class="part-title">
                                <h4>Details</h4>
                            </div>
                            <div class="part-content">
                                <div>
                                    <strong>Anyone</strong> can provide DEF tokens to the <strong>capital pool</strong>
                                    and become the <strong>insurer</strong> of all insurance agreements in
                                    cryptoProtector.The smart contract will issue sDEF tokens to the insurer as a
                                    capital certificate at a ratio of <strong>1:1</strong>.<strong>Premium
                                        income</strong> depends on <strong>the number of sDEF holdings</strong>.You can
                                    exchange sDEF back to DEF through the officially established trading pairs
                                    (<strong>Sell sDEF</strong> button on the right).<br><br>
                                </div>
                                <div class="row">
                                    <div class="col-xs-12 col-sm-12 col-md-6">
                                        <div class="input-item amount-item">
                                            <input id="amount-input" placeholder="0" oninput="changeAmountInput(event)">
                                            <span class="input-item-title">Amount</span>
                                            <div class="input-item-btns">
                                                <button>Pay</button>
                                            </div>
                                            <div class="input-item-unit">DEF</div>
                                        </div>
                                        <div class="error-item amount-error">
                                            <div class="dot"></div>
                                            <span>Enter a valid value (e.g. 1999).</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="part-wrap terms-wrap">
                            <div class="part-title">
                                <h4>Terms and conditions</h4>
                            </div>
                            <div class="terms-content">
                                <!-- <div>Events covered:</div>
                                    <ul>
                                        <li>contract bugs</li>
                                        <li>economic attacks, including oracle failures</li>
                                        <li>governance attacks</li>
                                    </ul>
                                    <div>Supported chains:</div>
                                    <div class="chains-row">
                                        <img class="icon icon-eth2" src="./assets/img/launch/eth2.png"/>
                                        <span>Ethereum,</span>
                                        <img class="icon icon-polygon" src="./assets/img/launch/polygon.svg"/>
                                        <span>Polygon</span>
                                    </div>
                                    <div>Claiming:</div> -->
                                <ul>
                                    <li>When sDEF transfers, the agreement will automatically settle the premium income
                                        that the transferor and the transferee have already obtained but not received to
                                        both parties.</li>
                                    <li>The use of sDEF to participate in the official mining pool mining period will
                                        not affect the original holders of sDEF to continue to capture the premium
                                        income.</li>
                                </ul>
                                <!-- <div>This cover is not a contract of insurance. Cover is provided on a discretionary basis with Nexus Mutual members having the final say on which claims are paid.</div> -->
                                <!--  <div class="check-row">Check out full details
                                        <a target="_blank" href="https://nexusmutual.io/pages/ProtocolCoverv1.0.pdf" class="here-btn">
                                            <span>here</span>
                                            <svg t="1631090954297" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2161" width="16" height="16"><path d="M930.909091 605.090909v325.818182H93.090909V93.090909h325.818182v93.090909H186.181818v651.636364h651.636364V605.090909h93.090909z m-93.090909-350.231273L449.722182 642.955636 383.883636 577.163636 774.865455 186.181818H605.090909V93.090909h325.818182v325.818182h-93.090909v-164.049455z" fill="#7868e6" p-id="2162"></path></svg>
                                        </a>.</div> -->
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-4">
                        <div class="part-wrap summary-wrap">
                            <div class="part-title">
                                <h4>Summary</h4>
                            </div>
                            <div class="summary-top">
                                <div>
                                    <img src="./assets/img/launch/icon1.png" />
                                </div>
                                <div>
                                    <div class="main-title">All protected protocols</div>
                                    <div class="sub-title">Protocol</div>
                                </div>
                            </div>
                            <div class="summary-row">
                                <div>Capacity:</div>
                                <div><span id="capacity">0</span> DEF </div>
                            </div>
                            <div class="summary-row">
                                <div>My pool share:</div>
                                <div>50%</div>
                            </div>
                            <div class="summary-row">
                                <div>Earned reward:</div>
                                <div><span id="myEarnedCPT">0</span> DEF</div>
                            </div>
                            <div id="claim-reward-btn" class="summary-btn wow bounceIn" data-wow-delay=".6s"
                                onclick="claimEarnedCPT()">Claim reward</div>
                            <div id="provide-capacity-btn" class="summary-btn wow bounceIn" data-wow-delay=".6s"
                                onclick="provideCapital()">Provide capacity</div>
                            <a href="#" class="summary-btn wow bounceIn" data-wow-delay=".6s">Sell sDEF</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- START FOOTER -->
    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 col-sm-12 col-xs-12 text-center">
                    <div class="footer_logo">
                        <img src="assets/img/logo-footer.png" alt="" />
                    </div>
                    <div class="language_selection">
                        <select aria-label="Language selector" class="languageselect">
                            <option selected="" value="en">English</option>
                            <option value="de">Deutsch</option>
                        </select>
                    </div>
                    <div class="copyright">
                        <p>&copy; 2021 cryptoProtector. All Rights Reserved.</p>
                    </div>
                    <div class="social_profile">
                        <ul>
                            <li><a href="https://t.me/CryptoProtector" class="f_twitter"><i
                                        class="fa fa-telegram"></i></a></li>
                            <li><a href="#" class="f_facebook"><i class="fa fa-github" title="Facebook"></i></a></li>
                            <li><a href="https://twitter.com/CPTProtector" class="f_twitter"><i class="fa fa-twitter"
                                        title="Twitter"></i></a></li>
                            <li><a href="https://cptprotector.medium.com" class="f_instagram"><i class="fa fa-medium"
                                        title="LinkedIn"></i></a></li>
                        </ul>
                    </div>
                </div>
                <!--- END COL -->
            </div>
            <!--- END ROW -->
        </div>
        <!--- END CONTAINER -->
    </div>
    <!-- END FOOTER -->

    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-body" style="text-align: center;">
                    Comming Soon
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Latest jQuery -->
    <script src="assets/js/jquery-1.12.4.min.js"></script>
    <!-- Latest compiled and minified Bootstrap -->
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <!-- modernizer JS -->
    <script src="assets/js/modernizr-2.8.3.min.js"></script>
    <!-- owl-carousel min js  -->
    <script src="assets/owlcarousel/js/owl.carousel.min.js"></script>
    <!-- jquery counterup -->
    <script src="assets/js/jquery.counterup.min.js"></script>
    <script src="assets/js/countdown.js"></script>
    <!-- jquery nav -->
    <script src="assets/js/jquery.nav.js"></script>
    <!-- jquery.slicknav -->
    <script src="assets/js/jquery.slicknav.js"></script>
    <!-- jquery.smooth-scroll -->
    <script src="assets/js/smooth-scroll.js"></script>
    <!-- magnific-popup js -->
    <script src="assets/js/jquery.magnific-popup.min.js"></script>
    <!-- scrolltopcontrol js -->
    <script src="assets/js/scrolltopcontrol.js"></script>
    <!-- WOW - Reveal Animations When You Scroll -->
    <script src="assets/js/wow.min.js"></script>
    <!-- jquery leanModal min js -->
    <script src="assets/js/jquery.leanModal.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <!-- login js -->
    <script src="assets/js/login.js"></script>
    <!-- scripts js -->
    <script src="assets/js/scripts.js"></script>

    <script type="text/javascript">
        //初始化web3
        var web3Provider;
        var web3js;

        if (window.ethereum) {
            web3Provider = window.ethereum;
        } else if (window.web3) {
            web3Provider = window.web3.currentProvider;
        } else {
            web3Provider = new Web3.providers.HttpProvider("https://tc7-eth.aca-dev.network");
        }

        web3js = new Web3(web3Provider);

        //链接钱包的方法
        function linkWallet() {
            if (ethereum) {
                web3Provider = ethereum;
                // 新版需要请求用户授权
                try {
                    // ethereum.enable();
                    ethereum.request({ method: 'eth_requestAccounts' });
                } catch (error) {
                    alert("用户取消授权");
                    return;
                }
            } else if (web3) {
                // MetaMask Legacy dapp browsers...
                web3Provider = web3.currentProvider;
                console.log("web3.currentProvider:");
                console.log(web3.currentProvider);
            } else {
                web3Provider = new Web3.providers.HttpProvider("https://tc7-eth.aca-dev.network");
                console.log("https://tc7-eth.aca-dev.network");
            }
            web3js = new Web3(web3Provider);
        }

        ethereum.on('accountsChanged', function (accounts) {
            if (accounts.length != 0) {
                let disLength = accounts[0].length
                document.getElementById("btn-wallet").innerText = accounts[0].substring(0, 5) + '***' + accounts[0].substring(disLength - 2, disLength);
                getEarnedCPT();
            } else {
                document.getElementById("btn-wallet").innerText = "Wallet";
                document.getElementById("myEarnedCPT").innerText = "0";
            }
        });

        //实例化合约
        var CPTInstance = new web3js.eth.Contract(CPTABI, "0x3561482c7cbaDa366bd8900f19b138cC6B26E309");
        var publicPool = new web3js.eth.Contract(publicPoolABI, "0x8d3a3f7ed091371efDE8e4261dD691aD423B460e")

        async function getCurrentAddress() {
            let selectedAddress = await web3js.eth.getAccounts();
            if (selectedAddress.length < 1) {
                document.getElementById("btn-wallet").innerHTML = "Wallet";
            } else {
                let disLength = selectedAddress[0].length
                document.getElementById("btn-wallet").innerText = selectedAddress[0].substring(0, 5) + '***' + selectedAddress[0].substring(disLength - 2, disLength);
            }
        }

        $(document).ready(function () {
            getCurrentAddress();
            getCapacity();
            getEarnedCPT();
        });

        function getCapacity() {
            publicPool.methods.useablePublicCapital().call(function (error, result) {
                if (!error) {
                    let finalResult = result / 1000000000000000000;
                    document.getElementById("capacity").innerHTML = finalResult.toFixed(2);
                }
            });
        }

        async function getEarnedCPT() {
            let selectedAddress = await web3js.eth.getAccounts();
            if (selectedAddress.length < 1) {
                document.getElementById("myEarnedCPT").innerText = "0";
            } else {
                publicPool.methods.earnedCPT(selectedAddress[0]).call(function (error, result) {
                    if (!error) {
                        document.getElementById("myEarnedCPT").innerText = result / 1000000000000000000;
                    }
                })
            }
        }

        async function claimEarnedCPT() {
            let selectedAddress = await web3js.eth.getAccounts();
            if (selectedAddress.length < 1) {
                linkWallet();
            } else {

                const url = 'https://tc7-eth.aca-dev.network';
                let response = await axios.post(url, {
                    id: 0,
                    jsonrpc: "2.0",
                    method: "eth_getEthGas",
                    params: []
                });
                let limit = response.data.result.gasLimit;
                let price = response.data.result.gasPrice;

                publicPool.methods.takeReward().send({
                    from: selectedAddress[0],
                    gasPrice: price,
                    gas: limit
                })
                    .on("receipt", function (receipt) {
                        console.log(receipt);
                    })
            }
        }

        async function provideCapital() {
            let selectedAddress = await web3js.eth.getAccounts();
            if (selectedAddress.length < 1) {
                linkWallet();
            } else {
                let allowanceOfCurrentAccount = await CPTInstance.methods.allowance(selectedAddress[0], "0x8d3a3f7ed091371efDE8e4261dD691aD423B460e").call();
                if (allowanceOfCurrentAccount == 0) {
                    let approveValue = 1000000000;
                    let approveValueString = approveValue.toString();
                    let approveValueToWei = web3js.utils.toWei(approveValueString, "ether");

                    CPTInstance.methods.approve("0x8d3a3f7ed091371efDE8e4261dD691aD423B460e", approveValueToWei).send(
                        { from: selectedAddress[0] },
                        function (error, transactionHash) {
                            if (!error) { console.log("transactionHash" + transactionHash); }
                        });
                } else {
                    var inputValue = document.getElementById("amount-input").value;
                    var capitalForProviding = web3js.utils.toWei(inputValue, "ether");

                    const url = 'https://tc7-eth.aca-dev.network';
                    let response = await axios.post(url, {
                        id: 0,
                        jsonrpc: "2.0",
                        method: "eth_getEthGas",
                        params: []
                    });
                    let limit = response.data.result.gasLimit;
                    let price = response.data.result.gasPrice;

                    publicPool.methods.provideCapital(capitalForProviding).send(
                        {
                            from: selectedAddress[0],
                            gasPrice: price,
                            gas: limit
                        }
                    ).on("receipt", function (receipt) {
                        console.log(receipt);
                    })
                }
            }
        }

        function changeAmountInput(event) {
            let val = event.target.value
            if (val == '' || (val && val >= 0 && !isNaN(Number(val)))) {
                $('.amount-item').removeClass('error-input-item')
                $('.amount-error').removeClass('show-error-item')
            } else {
                $('.amount-item').addClass('error-input-item')
                $('.amount-error').addClass('show-error-item')
            }
        }
    </script>
</body>

</html>